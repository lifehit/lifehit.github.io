<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Vulkan的programming model, LifeHit">
    <meta name="description" content="总结Vulkan的programming model以及涉及的相关组件和概念。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-0V4SV7JK5F"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-0V4SV7JK5F');
</script>


    <title>Vulkan的programming model | LifeHit</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="LifeHit" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">LifeHit</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">LifeHit</div>
        <div class="logo-desc">
            
            世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Vulkan的programming model</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Vulkan/">
                                <span class="chip bg-color">Vulkan</span>
                            </a>
                        
                            <a href="/tags/pipeline/">
                                <span class="chip bg-color">pipeline</span>
                            </a>
                        
                            <a href="/tags/driver/">
                                <span class="chip bg-color">driver</span>
                            </a>
                        
                            <a href="/tags/loader/">
                                <span class="chip bg-color">loader</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/" class="post-category">
                                计算机图形学
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-11-27
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    15 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <hr>
<h1 id="vulkan-application都需要什么"><a href="#vulkan-application都需要什么" class="headerlink" title="vulkan application都需要什么"></a>vulkan application都需要什么</h1><p>要完成一个Vulkan API编写的应用，需要哪些东西呢？如下图所示。</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/1.png" alt="vulkan application需要的组件"></p>
<ol>
<li>首先，你需要一个<strong>支持Vulkan的GPU</strong>，否则无法运行应用；</li>
<li>其次，你需要<strong>Vulkan Driver</strong>，这个不需要单独安装，一般和GPU一起绑定出厂；</li>
<li>第三，为了写一个application，你需要<strong>一套Vulkan SDK</strong>；</li>
<li>之后，写完的application需要运行<strong>SPIR-V格式的shader</strong>；</li>
<li>最后，application得到的结果，需要显示在屏幕上，你需要<strong>Windows System Integration</strong>。</li>
</ol>
<h2 id="具体描述"><a href="#具体描述" class="headerlink" title="具体描述"></a>具体描述</h2><h3 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h3><p>驱动是沟通application和GPU的中介，在application执行中，可以通过driver来查询GPU有多少可用的<code>PhysicalDevice</code>，每个<code>Device</code>中有多少个<code>Queue</code>，每个<code>Queue</code>具体什么功能。</p>
<p>Vulkan只是提供了一个统一的API，其具体的实现由各个硬件厂家完成，而这些厂家一般将驱动和对应的GPU绑定出厂，而驱动的功能和能效也是竞争力所在。</p>
<h3 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h3><p>由开发人员负责提供，用于执行图形渲染或者并发计算等任务。Vulkan programming model规范地说明了一个Vulkan application的一般化操作，下边会详述。</p>
<h3 id="Vulkan-SDK"><a href="#Vulkan-SDK" class="headerlink" title="Vulkan SDK"></a>Vulkan SDK</h3><p>用于支持Vulkan application的一系列工具，类似Java中的JDK。</p>
<h3 id="SPIR-V"><a href="#SPIR-V" class="headerlink" title="SPIR-V"></a>SPIR-V</h3><p>在GPU中通过可编程的shader来完成各种顶点计算、着色等操作，Vulkan中的shader是<a target="_blank" rel="noopener" href="https://www.khronos.org/spir/">SPIR-V格式</a>的——a precompiled binary format。这种形式的最大好处是在运行时不用编译了，提高了执行的效率，而且SDK中提供了compiler，可以将多种shader语言编写成SPIR-V的格式，如：<a target="_blank" rel="noopener" href="https://www.khronos.org/opengl/wiki/Core_Language_(GLSL)">GLSL</a>、HLSL等。</p>
<h3 id="WSI"><a href="#WSI" class="headerlink" title="WSI"></a>WSI</h3><p>Vulkan application的结果不一定要展现在屏幕上，比如并行计算的结果，即便是对于图形渲染的结果也不是强制的，但是为了方便开发，显现在屏幕上还是有很多的需求。但是Vulkan官方的规范中没有明确提出与window system交互，而是通过extension来实现的。<code>Windows System Integration</code>就是来自Khronos的一系列extensions，统一了对于Linux、Windows和Android等屏幕的呈现功能。</p>
<h1 id="Vulkan-programming-model"><a href="#Vulkan-programming-model" class="headerlink" title="Vulkan programming model"></a>Vulkan programming model</h1><p>什么是编程模型，“模型”肯定是对一系列事务的共性的描述，那编程模型，可以理解为对于编程这件事的共性的描述。编程模型之前可以添加很多的定语，来描述“什么样的编程”的共性，例如：有事件驱动的编程模型等。</p>
<p>那么这里，就容易理解了——要说的是，通过vulkan API进行编程的共性的描述。也就是使用Vulkan API编程，不管是复杂还是简单，你一般都需要干哪些事情，具体应该怎么干。</p>
<p>Vulkan programming model整体结构如下：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/2.png" alt="Vulkan programming model"></p>
<h2 id="Hardware-Initialization"><a href="#Hardware-Initialization" class="headerlink" title="Hardware Initialization"></a>Hardware Initialization</h2><p>在application开始正常运行之前，首先需要初始化硬件。<strong>所谓初始化硬件，需要找到操作GPU的driver，这个操作是通过定位loader来实现的</strong>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/Vulkan-Loader">Vulkan loader的文档</a>中说到：</p>
<blockquote>
<p>The ICD loader is a library that is placed between a Vulkan application and any number of Vulkan drivers, in order to support multiple drivers and the instance-level functionality that works across these drivers. Additionally, the loader manages inserting Vulkan layer libraries, such as validation layers, between an application and the drivers.</p>
</blockquote>
<p>简单说：</p>
<ul>
<li>loader是一个代码组件，主要任务是在application启动时去查找GPU对应的driver；</li>
<li>loader加载driver的方式在各个平台中是一致的。<ul>
<li>前面提到，在Vulkan中保证所有操作在所有平台都是一致的，不一致的地方通过extension的方式支持；</li>
</ul>
</li>
</ul>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/3.png" alt="loader所处的位置"></p>
<p>这个loader会还会完成哪些工作呢？在<a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/Vulkan-Loader/blob/master/docs/LoaderInterfaceArchitecture.md#overview">loader中存在一个layered architecture</a>。如下图所示：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/4.png" alt="Loader layered architecture"></p>
<p>对于不希望在vulkan API中实现的功能，可以通过在这里加一个layer来实现，以实现与vulkan driver的解耦，当需要这些功能时就打开（开发阶段），不需要就关闭（发布阶段）。具体包括以下功能：</p>
<ul>
<li><p>Error &amp; Validation for debugging purpose</p>
<p>在vulkan中，各种调试工作是通过validation layer实现的，不是vulkan core API的一部分，因此此时不需要找到vulkan driver。如<a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Setup/Validation_layers">Validation layers</a>所述。</p>
</li>
<li><p>Tracing vulkan API commands</p>
</li>
</ul>
<p>一旦loader找到对应的driver并且成功建立链接，后续application需要逐步完成：</p>
<ul>
<li><p>create vulkan instance</p>
<p>在vulkan中没有类似<a target="_blank" rel="noopener" href="https://softwareengineering.stackexchange.com/questions/380832/opengl-and-global-state">OpenGL的global state</a>，而是每个application都有自己的state，存储在<code>VkInstance</code>中，之后通过该对象初始化vulkan API，将application自身的信息传递出去。</p>
</li>
<li><p>query physical devices for available queues</p>
</li>
<li><p>query extensions and store them as function pointers</p>
<p>如WSI (Window System Integration) extensions等。</p>
</li>
<li><p>enable an injectable layer for error checking, debugging</p>
</li>
</ul>
<h2 id="Windowing-Presentation-Surface"><a href="#Windowing-Presentation-Surface" class="headerlink" title="Windowing Presentation Surface"></a>Windowing Presentation Surface</h2><p>在完成driver的加载后，需要完成绘制任务，为了将绘制的结果显示在屏幕上，需要完成两件事：</p>
<ol>
<li>perform the drawing task to build an image</li>
<li>put the image on the presentation window</li>
</ol>
<p>这两个任务都是与具体的平台密切相关的，但是在vulkan的设计哲学中，所有的API都尽量与平台解耦，以统一的方式提供。而且，Vulkan本身不直接提供关于window创建相关的API，而是通过extension的方式支持，因此这2个任务通过<a target="_blank" rel="noopener" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap33.html">Window System Integration（WSI）</a>完成：</p>
<ul>
<li><p>WSI中使用统一的API来创建window并且显示image，隐藏了技术细节，同时支持跨平台的功能。</p>
</li>
<li><p>WSI还支持<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Swap_chain">swap chain机制</a>，这种机制本质上是一个<a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Presentation/Swap_chain">images的队列</a>，当在屏幕上显示一张图像时，application可以处理下一张图像。</p>
<blockquote>
<p>Vulkan does not have the concept of a “default framebuffer”, hence it requires an infrastructure that will own the buffers we will render to before we visualize them on the screen. This infrastructure is known as the <strong>swap chain</strong> and must be created explicitly in Vulkan. <strong>The swap chain is essentially a queue of images that are waiting to be presented to the screen</strong>.</p>
</blockquote>
</li>
</ul>
<p>WSI作为Display和application之间的interface，在两者之间不断交换image，保证image轮转地在两者之间被处理。如下图所示：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/5.png" alt="WSI将image在Display和application之间轮换"></p>
<p>总的来说，此时通过WSI需要完成如下任务：</p>
<ul>
<li><p>通过调用本地的API实现创建一个window；</p>
</li>
<li><p>创建一个WSI Surface 附着到这个window上；</p>
<blockquote>
<p><code>VK_KHR_surface</code> exposes a <code>VkSurfaceKHR</code> object that represents an abstract type of <strong><a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Presentation/Window_surface">surface</a></strong> to present rendered images to.</p>
</blockquote>
</li>
<li><p>创建一个swapchain以便将image呈现到surface</p>
</li>
<li><p>向创建的swapchain请求已经绘制的image</p>
</li>
</ul>
<p>整个层次结构如下所示：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/6.png" alt="使用WSI显示图像的层次结构"></p>
<h2 id="Resource-Setup"><a href="#Resource-Setup" class="headerlink" title="Resource Setup"></a>Resource Setup</h2><p><strong>资源设置是什么意思？其本质很简单，就是存储vulkan应用的数据到内存空间中</strong>，以便在后续的程序中可以使用。<strong>在我们的语境下，所谓资源一般是指内存资源</strong>。</p>
<p>这里又要对比OpenGL和vulkan的区别了，OpenGL使用隐式的内存管理，而vulkan提供了low-level的API来操作底层的内存管理。在physical device中，vulkan提供了不同类型的内存，从而可以方便且显式地管理这些内存。</p>
<h3 id="内存资源的类型"><a href="#内存资源的类型" class="headerlink" title="内存资源的类型"></a>内存资源的类型</h3><blockquote>
<p>这里有疑问，所谓多种类型的memory是什么意思？memory不是一个统一的DDR吗？原因在于划分标准不同，按照性能和位置进行划分。</p>
</blockquote>
<p>在Vulkan中内存可以分为两种类型：</p>
<ul>
<li><p>host local</p>
<p>内存访问比较慢。</p>
<ul>
<li><p>host local, device visible</p>
<p>指的是host自己的内存资源，但是能被device访问。</p>
</li>
</ul>
</li>
<li><p>device local</p>
<p>这种内存在physical device中，具有高带宽的特点，比较快。</p>
<p>这种类型的内存可以进一步划分为：</p>
<ul>
<li>device local, host not visible</li>
<li>device local, host visible</li>
</ul>
</li>
</ul>
<h3 id="资源的管理过程"><a href="#资源的管理过程" class="headerlink" title="资源的管理过程"></a>资源的管理过程</h3><ol>
<li><p>创建resource objects</p>
<p> 这里要明确resource objects这个概念，我的理解是占据内存的是哪种类型的objects，比如用来存储images的内存，和用来存储buffer objects的内存。application负责为这些resource objects分配内存资源。</p>
</li>
<li><p>allocation &amp; suballocation</p>
<p> 当这些resource objects被创建后，它们只知道内存的virtual address，还不知道physical address，也就无法实际访问内存空间。而之后，application负责分配内存，并将这些virtual address绑定到physical address中，如<a target="_blank" rel="noopener" href="https://lifehit.cn/2022/10/29/ji-suan-ji-ji-chu/virtual-memory-1-jian-jie/">文章</a>所述。</p>
<p>   这里要注意一个问题，allocation是个expensive task，尽量不用多用，代替以suballocation，具体行为是，一次申请一大块内存空间，之后不再申请，而是将不同的resource objects放入到该内存空间中的各个小块。如下图所示：</p>
<p> <img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/7.png" alt="suballocation的行为"></p>
</li>
<li><p>sparse memory的支持</p>
<p> vulkan支持sparse memory。对于一个很大的object，例如image object，其超过了当前分配给其的内存空间，因此可以对其进行切分，分成很多的小块，存储到很多的小内存空间中，当application要使用该object时，根据放置这些小块时记录的映射关系，再加载回来，这个过程对于application是不可知的。</p>
<blockquote>
<p>基于sparse memory的方法，我的理解是会影响效率，写入时切分小块，读出时再组合，有额外的工作。其需要至少保存两类信息，与切分后各个小块的映射关系，各个小块之间的依赖关系。</p>
</blockquote>
</li>
<li><p>使用staging buffer作为数据中转站</p>
<p> 如果要将vertex等data放到内存中，最简单的方法是直接放到CPU中，即host local，然后让GPU执行任务时去读取。但是，前面说到，这种类型memory很慢，当都需要读取大量数据时，受限于带宽，无法实现最优的性能，因此将数据放到device local才是最理想的方式。基于此，需要首先在CPU上构建staging buffer，将数据传输到这里，然后再将这些数据转移到device local中，<a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Vertex_buffers/Vertex_input_description">vulkan-tutorial中有讲这个过程</a>。</p>
</li>
<li><p>异步传输数据</p>
<p> 完成了数据通道的构建，之后使用异步命令在graphic、DMA/tranfer queues中实现数据的传输。</p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>资源管理的流程可以总结如下：</p>
<ol>
<li><p>create resource objects</p>
</li>
<li><p>query the appropriate memory instance and create memory objects</p>
<p> 简单说就是，将申请一块大内存，并将其切分为小块，分配给各个resource objects。</p>
</li>
<li><p>get memory requirements for the allocation.</p>
<p> 分配的内存资源是否足够，要使用sparse memory机制吗？</p>
</li>
<li><p>allocate space and store data in it</p>
</li>
<li><p>bind the memory with the created resource objects</p>
</li>
</ol>
<h2 id="Pipeline-Setup"><a href="#Pipeline-Setup" class="headerlink" title="Pipeline Setup"></a>Pipeline Setup</h2><blockquote>
<p>a pipeline is a set of events that occur in a fixed sequence defined by the applcaition logic.</p>
</blockquote>
<p>这部分的工作包括：</p>
<ol>
<li>supply the shaders</li>
<li>bind the shaders to the resource allocated in <strong>resource setup</strong></li>
<li>manage the states of the pipeline</li>
</ol>
<h3 id="descriptor-sets"><a href="#descriptor-sets" class="headerlink" title="descriptor sets"></a>descriptor sets</h3><p>descriptor set是shaders和resources之间的桥梁，shaders通过descriptor sets实现对于resources的访问和使用。</p>
<p>descriptor sets有一系列特性：</p>
<ul>
<li><p>frequent change</p>
<p>  descriptor sets中存储了很多属性信息，类似关于texture等的，其数据变化的很频繁，而频繁地刷新descriptor sets是一项expensive task，极大地影响vulkan的性能。基于此，vulkan将descriptor sets在逻辑上划分为几个levels：</p>
<ul>
<li>scene : low frequecy udpate  </li>
<li>model : medium frequecy udpate</li>
<li>draw : high frequency update</li>
</ul>
<p>  这确保，对于draw level的高频更新不会影响scene等低频中descriptor sets对应的资源。</p>
</li>
<li><p>multithread scalability</p>
<p>  允许多个线程同时更新descriptor sets中的数据。</p>
</li>
<li><p>allocation mechnism</p>
<p>  descriptor sets是从descriptor pool中分配的，descriptor pool中维护了很多的descriptors，这些descriptor sets的同步由descriptor pool负责。</p>
</li>
</ul>
<h3 id="shaders-with-SPIR-V"><a href="#shaders-with-SPIR-V" class="headerlink" title="shaders with SPIR-V"></a>shaders with SPIR-V</h3><p>在vulkan中指定shader的方式只有通过SPIR-V这一种，但是具有如下特点：</p>
<ul>
<li><p>various source languages</p>
<p>  支持使用多种language编写human-reabable shaders，如：GLSL、HLSL，并使用LunarG提供的compiler编译成SPIR-V格式。</p>
</li>
<li><p>offline compilation</p>
<p>  vulkan中的shaders都是预先编译好的，不会在程序运行期间编译，提高了效率。</p>
</li>
</ul>
<h3 id="Pipeline-state-management"><a href="#Pipeline-state-management" class="headerlink" title="Pipeline state management"></a>Pipeline state management</h3><h4 id="pipeline-state是什么？"><a href="#pipeline-state是什么？" class="headerlink" title="pipeline state是什么？"></a>pipeline state是什么？</h4><blockquote>
<p>A physical device contains a range of hardware settings that determine how the submitted input data of a given geometry needs to be interpreted and drawn. These settings are collectively called pipeline states.</p>
</blockquote>
<p>状态可以分为2种类型：</p>
<ul>
<li>dynamic</li>
<li>static</li>
</ul>
<h4 id="state能干什么"><a href="#state能干什么" class="headerlink" title="state能干什么"></a>state能干什么</h4><p>这些state决定了创建哪种pipeline object（graphics/compute），而创建pipeline object是一个expensive task，最好只创建一次并且重用。</p>
<blockquote>
<p>为啥expensive？The VkPipeline is a huge object in Vulkan that encompasses the configuration of the entire GPU for the draw. Building them can be very expensive, as it will fully convert the shader module into the GPU instructions, and will validate the setup for it. 引自<a target="_blank" rel="noopener" href="https://vkguide.dev/docs/chapter-2/pipeline_walkthrough/">这里</a>。具体来说，包括对shader重新编译，并将这些shader绑定到对应的resource上等工作。</p>
</blockquote>
<p>根据不同的状态变量及其取值，可以组合成百上千种pipeline objects</p>
<p>pipeline object和pipeline cache object(PCO)、pipeline layout一起控制pipeline state：</p>
<ul>
<li><p>pipeline cache object</p>
<p>  因为pipeline的创建是expensive，因此一旦被创建，就会被cached。这样，当需要创建一个新的pipeline object时，就会寻找最接近的PCO，然后基于此base pipeline创建新的pipeline object。</p>
<p>  需要说明的是，PCO可以提供性能，但是，这需要application负责持久化该cache对象，并在创建新的pipeline object时，匹配合适的PCO。</p>
</li>
<li><p>pipeline layout</p>
<p>  该对象描述了给定一个pipeline object，shaders的输入信息是什么样的。具体来说，就是通过descriptor sets，将resources绑定到shaders的binding slot来建立映射关系，以便后续shaders能够读取相应的数据，完成drawing tasks。</p>
</li>
</ul>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>这个阶段，我们完成了：</p>
<ol>
<li><p>shaders are compiled into SPIR-V forms and specified in the pipeline shader state.</p>
</li>
<li><p>descirptor sets connect resources to shaders.</p>
</li>
<li><p>application creates pipeline objects from PCO for better peformance.</p>
</li>
</ol>
<h2 id="Command-Recordings"><a href="#Command-Recordings" class="headerlink" title="Command Recordings"></a>Command Recordings</h2><p>这一步就是收集各个commands，构建command buffer的过程，以便后续提交到queue中。</p>
<h3 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h3><p>为了记录application提交的commands，需要将它们包裹在一定的范围内，如下图是一个drawing command buffer被记录的描述：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/8.png" alt="commands recording for drawing"></p>
<p>简要介绍一下，如果完成command recording：</p>
<blockquote>
<p>这个过程是一般化的，具体的场景可能会有变化。</p>
</blockquote>
<ul>
<li><p><code>scope</code></p>
<p>指定command buffer recordings的开始和结束所框定的范围。</p>
</li>
<li><p><code>Render Pass</code></p>
<p>指定了任务的执行具体过程。</p>
<blockquote>
<p>对于render pass这个概念，一直比较迷糊，Vulkan spec中也没有细讲，可以参考下述的资料：</p>
</blockquote>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://developer.samsung.com/galaxy-gamedev/resources/articles/renderpasses.html">https://developer.samsung.com/galaxy-gamedev/resources/articles/renderpasses.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Render_passes#page_Render-pass">https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Render_passes#page_Render-pass</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://vkguide.dev/docs/chapter-1/vulkan_renderpass/">https://vkguide.dev/docs/chapter-1/vulkan_renderpass/</a></p>
</li>
</ul>
<p>一个比较清晰的描述如下：</p>
<blockquote>
<p>A VkRenderPass is a Vulkan object that encapsulates the state needed to setup the “target” for rendering, and the state of the images you will be rendering to.</p>
</blockquote>
<blockquote>
<p>The renderpass is a concept that only exists in Vulkan. It’s there because it allows the driver to know more about the state of the images you render.</p>
</blockquote>
</li>
<li><p><code>Pipeline</code></p>
<p>通过pipeline object指定各种状态信息。</p>
</li>
<li><p><code>descriptor</code></p>
<p>将内存资源与shaders建立联系，以便后续的数据的读写。</p>
</li>
<li><p><code>Bind resource</code></p>
<p>指定各种需要的数据，比如vertex buffer、images等，这些在执行任务时都要用到。</p>
</li>
<li><p><code>Viewport</code></p>
<p>确定了要进行rendering的surface，可以查看上面WSI部分那个图。</p>
</li>
<li><p><code>Scissor</code></p>
<p>定义了一个矩形区域，超过这个区域的内容不会被渲染。</p>
</li>
<li><p><code>Draw</code></p>
<p>具体的draw command，需要指定geometry buffer相关的属性信息，完成任务。</p>
</li>
</ul>
<h3 id="性能考虑"><a href="#性能考虑" class="headerlink" title="性能考虑"></a>性能考虑</h3><p>创建command buffer是一个expensive task，因此，Vulkan支持使用多线程的方式来创建command buffer，而且为了不因并发产生资源竞争，采用了command buffer pool的方式，如下：</p>
<p><img src="/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/Vulkan/Vulkan%E7%9A%84programming-model/9.png" alt="多线程使用command buffer pool"></p>
<p>每个单独的线程对应一个command buffer pool，既可以重用command buffer，又不担心资源竞争。</p>
<h2 id="Queue-Submission"><a href="#Queue-Submission" class="headerlink" title="Queue Submission"></a>Queue Submission</h2><p>当上述的command buffer构建成功后，就被提交到queue中进行处理。vulkan中有不同类型的queue，根据job的不同属性，可以选择不同类型的queue。</p>
<ul>
<li>对于compute任务，需要提交到compute queue；</li>
<li>对于graphics任务，需要提交到graphics queue；</li>
</ul>
<p>这些提交的job以异步的方式执行，如果希望进行同步，需要application显式管理。</p>
<p>具体来说，这一阶段完成了：</p>
<ul>
<li>从sawpchain中获取下一个需要被draw的frame；</li>
<li>application设置各种同步机制，以便协调不同commands；</li>
<li>将收集的command记录到command buffer中，并提交到特定的queue中；</li>
<li>请求将绘制完成的images展现到output device中；</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Shader_modules">https://vulkan-tutorial.com/Drawing_a_triangle/Graphics_pipeline_basics/Shader_modules</a></li>
<li><a target="_blank" rel="noopener" href="https://vulkan-tutorial.com/Drawing_a_triangle/Presentation/Window_surface">https://vulkan-tutorial.com/Drawing_a_triangle/Presentation/Window_surface</a></li>
<li>Learning Vulkan - Chapter 1 - Understanding the Vulkan application &amp; Getting started with the Vulkan programming model</li>
<li><a target="_blank" rel="noopener" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap4.html">https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap4.html</a></li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">alex Li</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://limeya.github.io/2022/11/27/ji-suan-ji-tu-xing-xue/vulkan/vulkan-de-programming-model/">https://limeya.github.io/2022/11/27/ji-suan-ji-tu-xing-xue/vulkan/vulkan-de-programming-model/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">alex Li</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Vulkan/">
                                    <span class="chip bg-color">Vulkan</span>
                                </a>
                            
                                <a href="/tags/pipeline/">
                                    <span class="chip bg-color">pipeline</span>
                                </a>
                            
                                <a href="/tags/driver/">
                                    <span class="chip bg-color">driver</span>
                                </a>
                            
                                <a href="/tags/loader/">
                                    <span class="chip bg-color">loader</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/11/28/bian-cheng-zhi-dao/c-xian-cheng-thread-de-ji-ben-shi-yong-fang-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="C++线程：thread的基本使用方式">
                        
                        <span class="card-title">C++线程：thread的基本使用方式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍C++线程管理中最基本的thread的使用方式。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-11-28
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93/" class="post-category">
                                    编程之道
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%BA%BF%E7%A8%8B/">
                        <span class="chip bg-color">线程</span>
                    </a>
                    
                    <a href="/tags/thread/">
                        <span class="chip bg-color">thread</span>
                    </a>
                    
                    <a href="/tags/join/">
                        <span class="chip bg-color">join</span>
                    </a>
                    
                    <a href="/tags/detach/">
                        <span class="chip bg-color">detach</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/11/27/bian-cheng-zhi-dao/c-nei-cun-guan-li-shi-yong-allocator-guan-li-dynamic-array/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="C++内存管理：使用allocator管理dynamic array">
                        
                        <span class="card-title">C++内存管理：使用allocator管理dynamic array</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍C++11新标准中的allocator类，可以实现将内存分配与初始化解耦，以提升性能。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-11-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93/" class="post-category">
                                    编程之道
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/dynamic-array/">
                        <span class="chip bg-color">dynamic array</span>
                    </a>
                    
                    <a href="/tags/allocator/">
                        <span class="chip bg-color">allocator</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <a href="/about" target="_blank">alex Li</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">110.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "11";
                        var startDate = "13";
                        var startHour = "20";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/limeya" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:lmy86263@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1215869909" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1215869909" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>



    <a href="https://blog.csdn.net/lmy86263" class="tooltipped" target="_blank" data-tooltip="访问csdn" data-position="top" data-delay="50">
		<i class="fab fa-blogger"></i>
    </a>




</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
